import struct
import matplotlib.pyplot as plt

# ==============================
# BURAYA GELEN HEX VERİYİ YAPIŞTIR
# ==============================
hex_data = """
FEC96D356732009F8D41D6D00BE71F0600F9FFAC260AD8BD104B7001001320031E
FF7F3E005D910076DA
FF7F48005D930076D6
FF7F4B005D930076DA
FF7F4F005D930076E0
FF7F51005D940076E4
FF7F53005D920076F0
FF7F54005D950076FF
FF7F56005D95007710
FF7F58005D96007718
FF7F57005D96007717
FF7F58005D93007704
FF7F5B005D950076F2
FF7F59005D930076DB
FF7F5E005D950076C3
FF7F5C005D960076B3
FF7F5D005D980076A7
FF7F5F005D970076A5
FF7F5E005D960076A8
FF7F5E005D940076A9
FF7F5F005D980076AA
FF7F60005D950076A8
FF7F61005D990076A4
FF7F62005D9600769D
FF7F63005D970076A2
FF7F62005D99007695
FF7F63005D96007692
FF7F62005D9700768E
FF7F62005D9A007691
FF7F63005D98007697
FF7F63005D96007694
FF7F64005D99007695
FF7F65005D98007693
FF7F65005D99007699
FF7F67005D980076A7
FF7F67005D960076D4
FF7F68005D9A0076F0
FF7F67005D9800770C
FF7F69005D9A00772A
FF7F69005D9A00773D
FF7F6B005D99007744
FF7F69005D99007751
FF7F6B005D99007753
FF7F6C005D99007747
FF7F6B005D9A007737
FF7F6A005D9900771B
FF7F6D005D9A007702
FF7F77005D9C007666
FF7F77005D9D00766A
FF7F76005D9D00766A
FF7F76005D9E00766A
FF7F77005D9E00766B
FF7F76005D9B00766B
FF7F78005D9D00765E
FF7F78005D9D00766B
FF7F79005D9B00766D
FF7F78005D9E00766C
FF7F79005D9E00766A
FF7F7B005D9D00766B
FF7DC7005D22006A57
FF7DB5005D21006A2D
FF7D7D005D120069DF
FF7D5D005D070069A5
FF7D2C005CFF00696A
FF7D09005CF3006951
FF7D04005CF1006946
FF7CFC005CF300693E
FF7CF9005CF7006940
FF7CE5005CF1006939
FF7CD5005CE900692D
FF7CD1005CE7006929
FF7CA4005CDD00691A
FF7C8E005CD700690D
FF7C7A005CD200690C
FF7C44005CC3006926
FF7C22005CBA00698B
FF7C1A005CB7006992
FF7C07005CB2006976
FF7BF3005CAD00695E
FF7BDD005CAA00695F
FF7BC9005CA2006951
FF7BA4005C9A006947
FF7B8A005C91006943
FF7B7B005C8B006956
FF7B75005C8C006951
FF7B67005C8400694C
FF7B60005C81006949
FF7B49005C7D006950
FF7B3E005C7600694B
FF8079005DDE007495
FF807E005DDE007499
FF807F005DDF0074B9
FF807F005DE00074E3
FF807A005DDC0074F7
FF8079005DDD0074FB
FF8075005DDD0074F7
FF8073005DDB007501
FF8070005DDB0074F1
FF806B005DD90074D7
FF8069005DDA0074C7
FF8066005DD90074D6
FF8062005DD70074EF
FF805E005DD70074FB
FF805A005DD500750B
FF8056005DD4007501
FF8053005DD70074F5
FF8050005DD50074E1
FF804F005DD30074CB
FF804B005DD10074C1
FF8050005DD40076AF
FF804F005DD40077CA
FF804A005DD2007777
FF8045005DD2007759
FF8044005DD00076FD
FF803E005DD0007695
FF803C005DCE007647
FF7B61005C7F006986
FF7B5B005C7D006992
FF7B35005C7400698F
FF7B13005C6A00698F
FF7B06005C650069B8
FF7AC0005C55006C37
FF7A74005C410070F1
FF7A5D005C340073A4
FF7A66005C390073ED
FF7A5B005C360072B6
FF7A49005C35007153
FF7A30005C2B007026
FF7A1F005C28006F27
FF79F6005C1B006E62
FF79D9005C17006DC7
FF79B7005C09006D53
FF799E005C02006CFF
FF799C005C01006CB6
FF798B005BFE006C7D
FF7965005BF1006C45
FF793B005BE7006C23
FF78F3005BD1006C07
FF789C005BB7006C09
FF786D005BA8006C19
FF7879005BAD006C30
FF7890005BB9006C39
FF78A0005BBB006C35
FF7887005BB6006C43
FF7847005BA3006C4A
FF77F5005B8D006C53
FF77D8005B83006C5B
FF77CF005B7D006C68
FF77E2005B80006C66
FF77F5005B88006C85
FF77F6005B8A006CF9
FF77E9005B89006D11
FF77D6005B83006D3D
FF77D8005B83006D5F
FF77DF005B85006D5B
FF77B9005B7C006E2A
FF7783005B6C006F2B
FF778C005B7100718D
FF778F005B710073A1
FF775F005B640073B3
FF7758005B6300733B
FF7754005B6800728D
FF774B005B630071DD
FF773D005B5D007141
FF7736005B590070B2
FF773D005B5B00704B
FF773C005B59006FE8
FF772D005B55006FA3
FF7713005B4C006F7B
FF76F4005B45006FC3
FF76EC005B3F00700C
FF76ED005B4200702D
FF76F8005B4500703D
FF770A005B4A0070B4
FF7727005B51007219
FF7742005B590073C9
FF7759005B5F007573
FF776E005B670076EB
FF7782005B6D007843
FF7798005B73007975
FF77AB005B7A007A75
FF77C3005B81007B65
FF77DC005B87007C32
FF77F2005B8D007CE5
FF780F005B93007E17
FF79C0005C0C008344
FF7BCD005C990086D3
FF7B7F005C8700891E
FF7B1B005C690089EB
FF7BB3005C93008B54
FF7CA1005CD3008BE9
FF7C5E005CC5008C2D
FF7C62005CC5008BEA
FF7C4D005CBB008B9E
FF7C55005CC1008B8B
FF7C64005CC2008B7F
FF7C68005CC5008B75
FF7C9F005CD2008C58
FF7D49005D03008D25
FF7DC6005D23008D24
FF7E0B005D36008CD5
FF7E3A005D43008C64
FF7E2B005D41008BC4
FF7DB2005D1C008B36
FF7D63005D07008AE1
FF7D36005CFD008AAD
FF7D1C005CF4008A87
FF7D08005CF0008A66
FF7CF6005CE7008A42
FF7C13005CAB0087A9
FF7C0C005CA900876B
FF7C07005CA5008724
FF7C01005CA30086E0
FF7BFA005CA2008684
FF7BF5005CA2008611
FF7BF5005CA10085F9
FF7BF5005CA30085FA
FF7BF2005C9F00861A
FF7BF3005CA2008645
FF7BF2005CA3008689
FF7BF2005CA20086BB
FF7BF3005CA30086E5
FF7BF3005CA400871F
FF7BF2005CA3008753
FF7BF1005CA0008760
FF7BEF005CA100876C
FF7BF0005C9F008766
FF7BEF005CA3008769
FF7BED005CA2008763
FF7BEF005CA1008765
FF7BF1005CA2008776
FF7BF5005CA30087A1
FF7BF8005CA30087C9
FF7BF7005CA50087E8
FF7BFA005CA50087FE
FF7BFB005CA4008817
FF7BFD005CA3008820
FF7BFA005CA300881C
FF7BFB005CA50087B5
FF7C00005CA6008781
FF7C03005CA400876F
FF7C05005CA500875F
FF7C03005CA500870C
FF7C06005CA90086A1
FF7C06005CA7008660
FF7C0A005CA8008625
FF7C0B005CA90085FB
FF7C0E005CAB0085F0
FF7C0E005CA90085FD
FF7FC0005E710077B9
FF7FCA005E730077B3
FF7FCF005E750077B3
FF7FD2005E740077AF
FF7FD6005E780077A2
FF7FD6005E7600779D
FF7FD9005E7400779B
FF7FDA005E78007795
FF7FDD005E79007796
FF8016005E890077B5
FF8092005EA400778B
FF812A005ECD007712
FF819D005EEC007686
FF8214005F0A0075DA
FF8287005F28007531
FF82F1005F48007490
FF835B005F630073F4
FF83C6005F8100734F
FF8426005F9B0072AB
FF8461005FAA007235
FF8455005FA8007205
FF842E005F9D0071EA
FF8419005F960071D3
FF8410005F950071BA
FF8407005F930071A1
FF8403005F9200719C
FF83FD005F8F007193
FF83F9005F8C00717E
FF8484005FB3007112
FF84FB005FCD0070A7
FF8575005FEF00701B
FF85D6006008006FA8
FF862D00601E006F36
FF86B8006047006E9B
FF8758006071006DF6
FF872B006064006DDD
FF86D300604E006DFD
FF86A7006041006E0C
FF869100603A006E0F
FF8686006038006E16
FF8686006039006E10
FF8727006068006DA3
FF881100609B006CDF
FF887E0060BC006C60
FF88BB0060CE006C15
FF89000060DC006BC7
FF89280060E7006B92
FF893D0060EC006B66
FF892F0060E7006B5B
FF890D0060E0006B5E
FF88EB0060D9006B77
FF88D80060D5006B8A
FF88CB0060D3006B8B
FF88BD0060CD006B9A
FF88B00060CB006B9A
FF88A20060C8006B9C
FF88970060C8006B9D
FF888A0060C3006B9E
FF887B0060BD006BA6
FF886D0060B9006BAC
FF88590060B3006BA9
FF88480060B2006BB3
FF88340060AA006BCB
FF881F0060A5006BD8
FF880B00609C006BF1
FF87F2006099006C09
FF87DD006095006C22
FF87CB00608E006C23
FF87BE00608A006C28
FF87AF006087006C33
FF87A2006084006C35
FF8793006081006C3F
FF8786006081006C4E
FF877900607D006C50
FF876C006078006C64
FF875C006075006C69
FF874E006073006C6C
FF874100606E006C67
FF873200606B006C6D
FF8724006065006C70
FF8717006060006C72
FF870800605B006C7B
FF86F7006059006C80
FF86EB006057006C86
FF80AC005EAA006856 
FF80A4005EA8006801 
FF809E005EA60067E1 
FF8091005EA30067A9 
FF8085005E9E00678B 
FF8078005E9B006778 
FF8071005E9B00677D 
FF8064005E9500675E 
FF8059005E93006731 
FF8051005E8F00670D 
FF8042005E8B006730 
FF802F005E8700672F 
FF8021005E830066F8 
FF800E005E820066AC 
FF7FC0005E690066CD 
FF7FA1005E610066D6 
FF7ED3005E2B006711 
FF7DD6005DE9006751 
FF7DF2005DEF0067DE 
FF7E8E005E18006842 
FF7EF3005E350068DC 
FF7F23005E430068DD 
FF7F13005E3E006859 
FF7D16005DB6006855 
FF7CBA005D9D0068AD 
FF7D93005DD600691D 
FF7E52005E08006AEC 
FF7EC5005E26006C9B 
FF7EFF005E36006DDB 
FF7F21005E3F006EFB 
FF7F60005E51007059 
FF7FE4005E73007165 
FF80E1005EB40071C8 
FF81F0005EFC00718E 
FF82FA005F480070F1 
FF83F2005F8B00703B 
FF84E8005FCB006F65 
FF85DC00600C006E87 
FF86D000604C006D9D 
FF87DE00608A006CAA 
FF891F0060DB006BAC 
FF8A82006135006A89 
FF8BAA00618500698B 
FF8CA30061C50068C9 
FF8D8C0062050067F5 
FF8E53006236006759 
FF8F110062670066BE 
FF8FC8006299006637 
FF90690062C20065C4 
FF91010062E5006567 
FF919900630B00650C 
FF92280063320064B2 
FF92A100634B00646F 
FF92AA00635300647F 
FF924C0063390064A7
FF80B6005D3B0075C4
FF80C1005D3C0075CF
FF80C7005D3C0075E9
FF80CC005D410075E5
FF80CD005D400075F8
FF80CE005D3F007601
FF80CD005D400075F7
FF80CF005D420075E8
FF80D1005D410075CB
FF80D3005D420075C5
FF80D1005D410075A4
FF80D3005D41007578
FF80D3005D41007556
FF80D2005D40007536
FF80D3005D40007523
FF80D4005D41007526
FF80D5005D4100752E
FF80D6005D42007526
FF80D5005D42007535
FF80D7005D41007534
FF80D7005D42007527
FF80D6005D42007525
FF80D7005D42007514
FF80D7005D41007507
FF80D7005D420074FB
FF80D7005D430074F6
FF80D7005D440074EF
FF80DA005D430074F2
FF80D8005D440074F5
FF80DA005D430074F6
FF80DA005D430074F6
FF80DA005D430074F1
FF80DC005D420074EB
FF80DE005D450074F5
FF80DD005D4400750C
FF80E2005D4500751A
FF80E1005D45007522
FF80E1005D45007534
FF80E0005D4500753C
FF80E2005D46007552
FF80E5005D45007568
FF80E7005D49007573
FF80E4005D49007580
FF80E7005D4800756B
FF80E9005D4A00755E
FF80E6005D4600754F
FF80E8005D47007531
FF80E9005D4700752C
FF80EA005D49007526
FF80EB005D47007522
FF80EA005D47007524
FF80EB005D47007520
FF80EB005D47007523
FF80EA005D48007513
FF80EA005D4A0074F5
FF80EA005D480074E2
FF80ED005D480074E3
FF80EC005D470074F1
FF80EB005D4700751B
FF80EF005D47007562
FF80EF005D48007578
FF80EE005D4700755C
FF80EC005D46007555
FF80EF005D4800756B
FF80EE005D48007573
FF80F1005D47007567
FF80F0005D47007545
FF80F1005D4700752A
FF80EF005D4800751D
FF80EF005D47007513
FF80EF005D48007521
FF80F2005D4900751D
FF80F2005D47007512
FF80F2005D4A007501
FF80F4005D4B0074FD
FF80F3005D4B00751A
FF80F3005D4900756A
FF80F6005D49007584
FF80F9005D4900757E
FF80FA005D49007567
FF80F9005D4B00754F
FF80FC005D49007545
FF80FB005D4B007526
FF80FA005D49007503
FF80F9005D4A0074DB
FF80F9005D490074D0
FF80FA005D4B0074D2
FF80FA005D4B0074D5
FF80FA005D4B0074CA
FF80FC005D4B0074C4
FF80FA005D4C0074C1
FF80FE005D4B0074CD
FF80FE005D4B0074D5
FF80FD005D4D0074D6
FF80FE005D4B0074CD
FF80FF005D4C0074D2

"""




# Hex string -> byte array
data = bytes.fromhex(hex_data)

# ==============================
# 1) KALİBRASYON AYIKLAMA
# ==============================

if data[0] != 0xFE:
    raise ValueError("Kalibrasyon başlangıcı FE değil!")

calib = data[1:33]   # 32 byte

def u16(lsb, msb):
    return (msb << 8) | lsb

def s16(lsb, msb):
    val = (msb << 8) | lsb
    if val & 0x8000:
        val -= 65536
    return val

dig_T1 = u16(calib[0], calib[1])
dig_T2 = s16(calib[2], calib[3])
dig_T3 = s16(calib[4], calib[5])

dig_P1 = u16(calib[6], calib[7])
dig_P2 = s16(calib[8], calib[9])
dig_P3 = s16(calib[10], calib[11])
dig_P4 = s16(calib[12], calib[13])
dig_P5 = s16(calib[14], calib[15])
dig_P6 = s16(calib[16], calib[17])
dig_P7 = s16(calib[18], calib[19])
dig_P8 = s16(calib[20], calib[21])
dig_P9 = s16(calib[22], calib[23])

dig_H1 = calib[24]
dig_H2 = s16(calib[25], calib[26])
dig_H3 = calib[27]
dig_H4 = (calib[28] << 4) | (calib[29] & 0x0F)
dig_H5 = (calib[30] << 4) | (calib[29] >> 4)
dig_H6 = struct.unpack("b", bytes([calib[31]]))[0]

print("Kalibrasyon yüklendi.")

# ==============================
# 2) FRAME ANALİZİ
# ==============================

frames = data[33:]

temperatures = []
pressures = []
humidities = []

i = 0
while i + 8 < len(frames):
    if frames[i] != 0xFF:
        i += 1
        continue

    adc_T = (frames[i+1] << 12) | (frames[i+2] << 4) | (frames[i+3] >> 4)
    adc_P = (frames[i+4] << 12) | (frames[i+5] << 4) | (frames[i+6] >> 4)
    adc_H = (frames[i+7] << 8) | frames[i+8]

    # ---- Sıcaklık hesap ----
    var1 = (((adc_T >> 3) - (dig_T1 << 1)) * dig_T2) >> 11
    var2 = (((((adc_T >> 4) - dig_T1) * ((adc_T >> 4) - dig_T1)) >> 12) * dig_T3) >> 14
    t_fine = var1 + var2
    T = (t_fine * 5 + 128) >> 8
    temperature = T / 100.0

    # ---- Basınç hesap ----
    var1 = t_fine - 128000
    var2 = var1 * var1 * dig_P6
    var2 = var2 + ((var1 * dig_P5) << 17)
    var2 = var2 + (dig_P4 << 35)
    var1 = ((var1 * var1 * dig_P3) >> 8) + ((var1 * dig_P2) << 12)
    var1 = (((1 << 47) + var1) * dig_P1) >> 33

    if var1 != 0:
        p = 1048576 - adc_P
        p = (((p << 31) - var2) * 3125) // var1
        var1 = (dig_P9 * (p >> 13) * (p >> 13)) >> 25
        var2 = (dig_P8 * p) >> 19
        p = ((p + var1 + var2) >> 8) + (dig_P7 << 4)
        pressure = p / 25600.0
    else:
        pressure = 0

    # ---- Nem hesap ----
    v_x1 = t_fine - 76800
    v_x1 = (((((adc_H << 14) - (dig_H4 << 20) - (dig_H5 * v_x1)) + 16384) >> 15) *
           (((((((v_x1 * dig_H6) >> 10) * (((v_x1 * dig_H3) >> 11) + 32768)) >> 10) + 2097152)
           * dig_H2 + 8192) >> 14))
    v_x1 = v_x1 - (((((v_x1 >> 15) * (v_x1 >> 15)) >> 7) * dig_H1) >> 4)
    v_x1 = max(0, min(v_x1, 419430400))
    humidity = (v_x1 >> 12) / 1024.0

    temperatures.append(temperature)
    pressures.append(pressure)
    humidities.append(humidity)

    i += 9

# ==============================
# 3) SONUÇLAR
# ==============================

for idx in range(len(temperatures)):
    print(f"{idx:03d} | {temperatures[idx]:.2f} °C | "
          f"{pressures[idx]:.2f} hPa | "
          f"{humidities[idx]:.2f} %RH")

# ==============================
# 4) GRAFİK
# ==============================
# 
plt.figure()
plt.plot(temperatures)
plt.title("Temperature (°C)")
plt.show()
# 
plt.figure()
plt.plot(pressures)
plt.title("Pressure (hPa)")
plt.show()
# 
plt.figure()
plt.plot(humidities)
plt.title("Humidity (%RH)")
plt.show()
